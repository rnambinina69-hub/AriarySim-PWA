<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AriarySim - Simulateur d'Investissement Mada</title>

    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#4CAF50"> <style>
        /* Variables et Style de Base (Th√®me Clair et Calme) */
        :root {
            --bg: #f5f7fa; /* Fond tr√®s clair, presque blanc */
            --card: #ffffff; /* Cartes blanches */
            --muted: #607d8b; /* Gris-bleu doux pour les textes secondaires */
            --text: #37474F; /* Gris fonc√© pour le texte principal */
            --accent: #4CAF50; /* Vert apaisant pour les actions positives/succ√®s */
            --info: #2196F3; /* Bleu clair pour les informations/param√®tres */
            --warn: #FFC107; /* Jaune/Orange doux pour les alertes/prudence */
            --border: #CFD8DC; /* Bordures gris tr√®s clair */
            --radius: 12px; /* Rayon des bords l√©g√®rement plus doux */
            --shadow: 0 6px 20px rgba(0, 0, 0, 0.08); /* Ombre plus douce */
            --transition-speed: 0.3s; /* Vitesse de transition pour les animations */
        }
        body {
            font-family: 'Roboto', sans-serif; /* Police moderne et lisible */
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 24px;
            line-height: 1.6; /* Ligne de texte l√©g√®rement plus espac√©e */
            animation: fadeIn 0.8s ease-out; /* Animation d'apparition de la page */
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .container { max-width: 1200px; margin: 0 auto; }
        h1 { margin: 0 0 8px; font-size: 2.4rem; color: var(--info); font-weight: 700; }
        .sub { color: var(--muted); margin-bottom: 24px; font-size: 1rem; }
        
        /* Layout Grid */
        .grid { display: grid; gap: 24px; grid-template-columns: 1fr; }
        @media (min-width: 992px) { .grid-2 { grid-template-columns: 2fr 1fr; } }
        @media (min-width: 1200px) { .grid-3 { grid-template-columns: 1.5fr 1fr 1fr; } }

        /* Cartes (Containers) */
        .card {
            background-color: var(--card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 20px 24px; /* Padding l√©g√®rement augment√© */
            box-shadow: var(--shadow);
            transition: transform var(--transition-speed) ease-out, box-shadow var(--transition-speed) ease-out;
        }
        .card:hover {
            transform: translateY(-3px); /* Effet l√©ger au survol */
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }
        
        /* Formulaires et Entr√©es */
        label { display: block; font-weight: 600; margin-bottom: 6px; font-size: 0.95rem; color: var(--text); }
        input, select {
            background-color: #ECEFF1; /* Gris tr√®s clair pour les champs */
            color: var(--text);
            border: 1px solid var(--border);
            border-radius: 8px; /* Bords plus ronds */
            padding: 12px; /* Padding augment√© pour plus d'espace */
            width: 100%;
            transition: border-color var(--transition-speed), box-shadow var(--transition-speed);
        }
        input:focus, select:focus { 
            border-color: var(--info); 
            outline: none; 
            box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.2); /* Ombre bleue l√©g√®re */
            background-color: var(--card); /* Fond blanc au focus */
        }
        input[type="number"] { text-align: right; }
        .row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; /* Espace augment√© */ }
        .row > div { margin-bottom: 16px; } /* Espace augment√© */
        .muted { color: var(--muted); font-size: 0.85rem; margin-top: 6px; line-height: 1.4; } /* Ligne de texte plus espac√©e */
        
        /* Boutons */
        .actions { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 20px; } /* Espace augment√© */
        .btn {
            cursor: pointer;
            padding: 12px 20px; /* Padding augment√© */
            border-radius: 8px; /* Bords plus ronds */
            font-weight: 600;
            transition: all var(--transition-speed) ease-out;
            border: none; /* Pas de bordure par d√©faut pour un look plus doux */
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        .btn:hover { 
            opacity: 0.9; 
            transform: translateY(-2px); 
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
        }
        .btn-primary { background-color: var(--info); color: white; }
        .btn-accent { background-color: var(--accent); color: white; }
        .btn-warn { background-color: var(--warn); color: var(--text); } /* Texte fonc√© sur bouton d'alerte */
        .btn-secondary { background-color: var(--bg); color: var(--text); border: 1px solid var(--border); box-shadow: none; }
        .btn-secondary:hover { background-color: #E0E0E0; transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0, 0, 0, 0.08); }


        /* Indicateurs Cl√©s (KPIs) */
        .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-top: 24px; }
        .kpi-card { 
            padding: 18px 20px; 
            border-left: 5px solid var(--info); /* Bordure color√©e √† gauche */
            background-color: var(--card);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            transition: transform var(--transition-speed) ease-out, border-left-color var(--transition-speed) ease-out;
        }
        .kpi-card:hover { transform: translateY(-3px); border-left-color: var(--accent); }
        .kpi-card h3 { margin: 0 0 6px; font-size: 1.05rem; color: var(--muted); font-weight: 500; }
        .kpi-val { font-size: 2rem; font-weight: 700; margin-top: 0; line-height: 1.2; }
        .kpi-sub { font-size: 1.2rem; color: var(--text); }
        .kpi-net-pos { color: var(--accent); }
        .kpi-net-neg { color: var(--warn); }
        .kpi-roi { color: var(--info); }
        .pill { 
            display: inline-block; padding: 6px 12px; border-radius: 999px; font-size: 0.9rem; margin-top: 8px; 
            background-color: #E0F2F7; /* Bleu tr√®s clair */
            color: var(--info);
            font-weight: 500;
        }
        
        /* Tableau */
        table { width: 100%; border-collapse: separate; border-spacing: 0; margin-top: 16px; border-radius: var(--radius); overflow: hidden;}
        th, td { 
            padding: 15px 12px; 
            text-align: left; 
            font-size: 0.9rem; 
            border-bottom: 1px solid var(--border); 
        }
        th { 
            background-color: #ECEFF1; /* Fond clair pour les en-t√™tes */
            color: var(--muted); 
            font-weight: 600; 
            text-transform: uppercase; 
            font-size: 0.8rem; 
        }
        tbody tr:last-child td { border-bottom: none; } /* Pas de bordure sur la derni√®re ligne */
        tbody tr:nth-child(even) { background-color: #F8F9FB; } /* L√©g√®re alternance de couleur */
        tbody tr:hover { background-color: #EBF2F7; } /* Effet de survol sur les lignes */

        .badge { 
            display: inline-block; 
            padding: 5px 10px; 
            border-radius: 999px; 
            font-size: 0.75rem; 
            font-weight: 600; 
            text-transform: uppercase;
        }
        .rev { background-color: #E8F5E9; color: #4CAF50; } /* Vert clair pour revenu */
        .dep { background-color: #FFEBEE; color: #F44336; } /* Rouge clair pour d√©pense */
        
        /* Projections */
        .projection-table tbody tr:nth-child(1) { font-weight: 700; background-color: #E3F2FD; color: #2196F3; } /* Ligne 1 mise en √©vidence */
        .projection-table tbody tr:nth-child(odd) { background-color: var(--card); }
        .projection-table tbody tr:nth-child(even) { background-color: #F8F9FB; }


        textarea {
            background-color: #ECEFF1;
            color: var(--text);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 12px;
            width: 100%;
            margin-top: 16px;
            min-height: 100px;
            resize: vertical;
            font-family: 'Consolas', 'Courier New', monospace; /* Police mono pour le JSON */
            transition: border-color var(--transition-speed), box-shadow var(--transition-speed);
        }
        textarea:focus {
            border-color: var(--info);
            box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.2);
            background-color: var(--card);
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>AriarySim üá≤üá¨</h1>
        <div class="sub">
            Simulez la rentabilit√© de votre projet √† Madagascar. Tenez compte de l'inflation, des risques, des taxes et des co√ªts r√©els pour une pr√©vision r√©aliste sur 4 ans. 
            **Conseil pour les D√©butants :** Le **Fonds de Roulement** (l'argent pour vos d√©penses des premiers mois) est un √©l√©ment cl√© √† inclure dans votre Capital Initial pour √©viter les mauvaises surprises.
        </div>

        <div class="grid grid-2">
            <div class="card" id="settings-card">
                <h2>‚öôÔ∏è Param√®tres Cl√©s de la Simulation</h2>
                <div class="row">
                    <div>
                        <label for="capital">Capital d‚Äôinvestissement initial (Ar)</label>
                        <input id="capital" type="number" min="0" step="1000" placeholder="Ex: 1 000 000 Ar" />
                        <div class="muted">
                            C'est le montant total dont vous avez besoin pour d√©marrer : mat√©riel, stock initial, et surtout le **Fonds de Roulement**.
                            *Exemple :* Si vous achetez 500 000 Ar de marchandises, 300 000 Ar de petit mat√©riel et pr√©voyez 200 000 Ar pour les d√©penses du 1er mois, votre capital initial est de 1 000 000 Ar.
                        </div>
                    </div>
                    <div>
                        <label for="activity">Domaine d'Activit√©</label>
                        <select id="activity">
                            <option value="Kiosque alimentaire">Kiosque alimentaire</option>
                            <option value="Friperie">Friperie</option>
                            <option value="Revente fruits/l√©gumes">Revente fruits/l√©gumes</option>
                            <option value="Photocopie/Impression">Photocopie/Impression</option>
                            <option value="Salon de coiffure">Salon de coiffure</option>
                            <option value="Artisanat">Artisanat</option>
                            <option value="Autres">Autres</option>
                        </select>
                        <div class="muted">S√©lectionnez le secteur pour un contexte.</div>
                    </div>
                </div>

                <hr style="border-top: 1px solid var(--border); margin: 20px 0;" />

                <h3>üìà Facteurs Macro-√©conomiques & Risques Locaux</h3>
                <div class="row">
                    <div>
                        <label for="inflationRate">Taux d'Inflation Annuel (%)</label>
                        <input id="inflationRate" type="number" min="0" step="0.1" placeholder="Ex: 8" />
                        <div class="muted">
                            L'**inflation** est la perte de pouvoir d'achat de la monnaie. Un taux √©lev√© signifie que vos co√ªts augmentent plus vite et que la valeur de vos revenus diminue avec le temps. 
                            *Exemple :* Si l'inflation est de 8%, un produit qui co√ªte 10 000 Ar aujourd'hui co√ªtera 10 800 Ar l'ann√©e prochaine.
                        </div>
                    </div>
                    <div>
                        <label for="riskFactor">Jours d'activit√© perdus par an (Risques)</label>
                        <input id="riskFactor" type="number" min="0" step="1" placeholder="Ex: 7" />
                        <div class="muted">
                            Nombre de jours o√π votre activit√© est ralentie ou compl√®tement arr√™t√©e. Cela impacte directement vos revenus.
                            *Exemple :* 3 jours de coupure JIRAMA, 2 jours de fortes pluies/cyclone, 2 jours d'√©v√©nements impr√©vus = 7 jours.
                        </div>
                    </div>
                </div>
                
                <h3>‚òÄÔ∏è Saisonnalit√© (Fluctuations de la Demande)</h3>
                <div class="row">
                    <div>
                        <label for="seasonalVariation">Variation Haute Saison (%)</label>
                        <input id="seasonalVariation" type="number" step="1" placeholder="Ex: 30" />
                        <div class="muted">Pourcentage d'augmentation (ou de diminution) de vos ventes par rapport √† la moyenne mensuelle.</div>
                    </div>
                    <div>
                        <label for="seasonalDuration">Dur√©e Haute Saison (Mois)</label>
                        <input id="seasonalDuration" type="number" min="0" max="12" step="1" placeholder="Ex: 4" />
                        <div class="muted">
                            Combien de mois par an vos ventes sont boost√©es (ou ralenties).
                            *Exemple :* Les f√™tes de fin d'ann√©e, la p√©riode de rentr√©e scolaire peuvent √™tre des "hautes saisons".
                        </div>
                    </div>
                </div>

                <hr style="border-top: 1px solid var(--border); margin: 20px 0;" />

                <h3>üèõÔ∏è Fiscalit√© & Co√ªts R√©els</h3>
                
                <div class="row">
                    <div>
                        <label for="taxRegime">R√©gime Fiscal</label>
                        <select id="taxRegime">
                            <option value="IS">IS (Imp√¥t sur les Soci√©t√©s - 20%)</option>
                            <option value="IR">IR (Imp√¥t sur les Revenus - Bar√®me progressif)</option>
                            <option value="ISyn">ISyn (Imp√¥t Synth√©tique - 5%)</option>
                        </select>
                        <div class="muted">
                            L'**Imp√¥t Synth√©tique (ISyn)** √† 5% est souvent le plus simple pour les micro-entreprises et TPE. L'**IS** (Imp√¥t sur les Soci√©t√©s) √† 20% est pour les entreprises plus √©tablies.
                        </div>
                    </div>
                    <div>
                        <label for="incomeTaxRate">Taux d'Imp√¥t sur les B√©n√©fices (%)</label>
                        <input id="incomeTaxRate" type="number" min="0" step="0.5" placeholder="Ex: 5" />
                        <div class="muted">
                            Le pourcentage d'imp√¥t appliqu√© sur votre **Profit Net** (ce qu'il reste apr√®s avoir d√©duit toutes les d√©penses de vos revenus).
                            *Exemple :* Si votre profit est de 1 000 000 Ar et le taux est de 5%, vous paierez 50 000 Ar d'imp√¥t.
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div>
                        <label for="vatRate">Taux de TVA (%)</label>
                        <input id="vatRate" type="number" min="0" step="1" placeholder="Ex: 20" />
                        <div class="muted">
                            La **TVA (Taxe sur la Valeur Ajout√©e)** est un imp√¥t sur la consommation. Si vous n'√™tes pas assujetti (petite activit√©), laissez ce champ √† 0. (Taux standard : 20%).
                        </div>
                    </div>
                    <div>
                        <label for="interestRate">Co√ªt d'opportunit√© du Capital Annuel (%)</label>
                        <input id="interestRate" type="number" min="0" step="0.1" placeholder="Ex: 12" />
                        <div class="muted">
                            C'est le "co√ªt" de l'argent que vous investissez. C'est soit le taux d'int√©r√™t d'un cr√©dit, soit ce que votre argent aurait rapport√© si vous l'aviez plac√© ailleurs.
                            *Exemple :* Si votre argent aurait rapport√© 12% dans un compte √©pargne, c'est votre co√ªt d'opportunit√©.
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div>
                        <label for="laborCostRatio">Charges Patronales (% Salaire Brut)</label>
                        <input id="laborCostRatio" type="number" min="0" step="1" placeholder="Ex: 15" />
                        <div class="muted">
                            Les charges sociales que l'employeur (vous) paie en plus du salaire de l'employ√© (CNAPS, OSTIE). Laissez √† 0 si vous n'avez pas d'employ√©s.
                        </div>
                    </div>
                    <div>
                        <label for="numEmployees">Nombre d'Employ√©s/Associ√©s</label>
                        <input id="numEmployees" type="number" min="0" step="1" placeholder="Ex: 2" />
                        <div class="muted">
                            Ceci est pour information. Assurez-vous d'ajouter tous les salaires (y compris le v√¥tre, si vous vous payez) dans les "Flux Saisis" comme 'Salaire Brut'.
                        </div>
                    </div>
                </div>

                <div class="actions">
                    <button class="btn btn-primary" id="saveSettings">Sauvegarder les Param√®tres</button>
                    <button class="btn btn-secondary" id="resetSettings">R√©initialiser l'√âtat</button>
                </div>
            </div>

            <div>
                <div class="card" style="margin-bottom: 24px;">
                    <h2>‚ûï Ajouter un Flux</h2>
                    <div class="row">
                        <div>
                            <label for="label">Libell√©</label>
                            <input id="label" type="text" placeholder="Ex: Vente de Riz / Loyer du local / Salaire du g√©rant" />
                        </div>
                        <div>
                            <label for="amount">Montant (Ar)</label>
                            <input id="amount" type="number" min="0" step="1000" placeholder="Ex: 50 000" />
                        </div>
                    </div>
                    <div class="row" style="margin-top: 12px;">
                        <div>
                            <label for="type">Type de Flux</label>
                            <select id="type">
                                <option value="revenue">Revenu Brut</option>
                                <option value="expense">D√©pense (Stock, Loyer, Mat√©riel)</option>
                                <option value="labor">Salaire Brut (d√©clenche les charges sociales patronales)</option>
                            </select>
                            <div class="muted">
                                Un **Revenu** (vos ventes), une **D√©pense** (loyer, mati√®res premi√®res) ou un **Salaire Brut** (pour vous ou vos employ√©s).
                            </div>
                        </div>
                        <div>
                            <label for="freq">Fr√©quence</label>
                            <select id="freq">
                                <option value="week">Hebdomadaire</option>
                                <option value="month">Mensuelle</option>
                                <option value="year">Annuelle</option>
                                <option value="once">Ponctuelle (une seule fois l'Ann√©e 1)</option>
                            </select>
                            <div class="muted">√Ä quelle fr√©quence ce montant est-il g√©n√©r√© ou d√©pens√© ?</div>
                        </div>
                    </div>
                    <div style="margin-top: 12px;">
                        <label for="note">Note</label>
                        <input id="note" type="text" placeholder="Ex: March√© Anosy, promo, saison haute‚Ä¶" />
                    </div>
                    <div class="actions">
                        <button class="btn btn-accent" id="addItem">Ajouter le Flux</button>
                        <button class="btn btn-secondary" id="clearItems">Tout Supprimer</button>
                    </div>
                </div>

                <div class="card">
                    <h2>üìã Flux Saisis</h2>
                    <table id="itemsTable">
                        <thead>
                            <tr>
                                <th>Libell√©</th>
                                <th>Type</th>
                                <th>Fr√©q.</th>
                                <th>Montant (Ar)</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                    <div class="muted" style="margin-top: 10px;">Derni√®re sauvegarde: <span id="lastSaved">Jamais</span></div>
                </div>
            </div>
        </div>

        <div class="card kpi-grid" style="margin-top: 24px;">
            <div class="kpi-card">
                <h3>Total Revenus (HT)</h3>
                <div class="kpi-val kpi-net-pos" id="revYear">0 Ar/an</div>
                <div class="kpi-sub" id="revMonth">0 Ar/mois</div>
            </div>
            <div class="kpi-card">
                <h3>Total D√©penses</h3>
                <div class="kpi-val kpi-net-neg" id="expYear">0 Ar/an</div>
                <div class="kpi-sub" id="expMonth">0 Ar/mois</div>
            </div>
            <div class="kpi-card">
                <h3>Profit Net (Apr√®s Imp√¥t)</h3>
                <div class="kpi-val kpi-net-pos" id="netYear">0 Ar/an</div>
                <div class="kpi-sub" id="netMonth">0 Ar/mois</div>
            </div>
            <div class="kpi-card">
                <h3>Rentabilit√© & Payback</h3>
                <div class="kpi-val kpi-roi" id="roiYear">0 %/an</div>
                <div class="pill" id="payback">Point mort: ‚Äî</div>
            </div>
        </div>

        <div class="card" style="margin-top:16px;">
            <h2>üîÆ Projections Annuelles (Ann√©e 1 √† 4)</h2>
            <table id="projectionTable" class="projection-table">
                <thead>
                    <tr>
                        <th>Ann√©e</th>
                        <th>Revenu Total (HT)</th>
                        <th>D√©pense Totale</th>
                        <th>Profit Net (Ar)</th>
                        <th>ROI (%)</th>
                    </tr>
                </thead>
                <tbody>
                    </tbody>
            </table>
            <div class="muted" style="margin-top: 10px;">Projections bas√©es sur le taux d'inflation saisi (effet cumul√©).</div>
        </div>

        <div class="card" style="margin-top: 16px;">
            <h2>üóÇÔ∏è Gestion des Donn√©es</h2>
            <div class="actions">
                <button class="btn btn-secondary" id="exportData">Exporter (JSON)</button>
                <button class="btn btn-secondary" id="importData">Importer (JSON)</button>
                <button class="btn btn-warn" id="wipeData">Effacer Toute la Sauvegarde Locale</button>
            </div>
            <textarea id="jsonArea" rows="4" placeholder="Collez ici des donn√©es JSON pour importer ou cliquez sur Exporter"></textarea>
        </div>
    </div>

    <script>
        // Enregistrement du Service Worker pour l'installation PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                // NOTE: Assurez-vous que le chemin est correct (ici √† la racine)
                navigator.serviceWorker.register('./service-worker.js')
                    .then((registration) => {
                        console.log('ServiceWorker enregistr√© avec succ√®s:', registration.scope);
                    })
                    .catch((error) => {
                        console.error('√âchec de l\'enregistrement du ServiceWorker:', error);
                    });
            });
        }
    </script>
    <script>
        // --- Helpers ---
        const fmt = (n) => new Intl.NumberFormat('fr-FR', { maximumFractionDigits: 0 }).format(Math.max(0, Math.round(n))) + " Ar";
        const DATE_FMT = new Intl.DateTimeFormat('fr-FR', { dateStyle: 'medium', timeStyle: 'short' });
        const toNum = (v) => isNaN(parseFloat(v)) ? 0 : parseFloat(v);

        // --- Constants ---
        const WEEKS_IN_YEAR = 52;
        const MONTHS_IN_YEAR = 12;
        const WEEKS_IN_MONTH = 30 / 7; // ~4.2857

        // --- State in localStorage ---
        const KEY = "ariarysim_state_v2";
        const defaultState = {
            capital: 1000000,
            activity: "Kiosque alimentaire",
            items: [], 
            lastSaved: null,
            inflationRate: 8,
            riskFactor: 7,
            seasonalVariation: 30,
            seasonalDuration: 4,
            taxRegime: "ISyn",
            incomeTaxRate: 5, 
            vatRate: 20,
            bankFeeRate: 3,         
            interestRate: 12,       
            utilityCostRatio: 5,    
            logisticsCostRatio: 7,
            laborCostRatio: 15,
            numEmployees: 0, 
        };
        let state = load();

        function load() {
            try {
                const raw = localStorage.getItem(KEY);
                if (!raw) return { ...defaultState };
                const parsed = JSON.parse(raw);
                return { ...defaultState, ...parsed, items: Array.isArray(parsed.items) ? parsed.items : [] };
            } catch (e) {
                console.error("Erreur de chargement des donn√©es locales:", e);
                return { ...defaultState };
            }
        }

        function save() {
            state.lastSaved = new Date().toISOString();
            localStorage.setItem(KEY, JSON.stringify(state));
            document.getElementById("lastSaved").textContent = DATE_FMT.format(new Date(state.lastSaved));
            render();
        }
